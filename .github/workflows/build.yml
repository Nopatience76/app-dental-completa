name: Build Android APK - DEBUG

on: 
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install essential dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          python3-dev \
          python3-pip \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          libpng-dev \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libsqlite3-dev \
          libgdbm-dev \
          libbz2-dev \
          libreadline-dev \
          liblzma-dev \
          tk-dev
        
    - name: Install Buildozer
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install buildozer==1.5.0
        pip install cython==0.29.33
        pip install kivy==2.3.0
        
    - name: Setup environment
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        export ANDROIDSDK="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROIDNDK="$HOME/.buildozer/android/platform/android-ndk-r25c"
        export ANDROIDAPI="33"
        export NDKAPI="21"
        
        echo "=== Variables de entorno ==="
        echo "PATH: $PATH"
        echo "ANDROIDSDK: $ANDROIDSDK"
        echo "ANDROIDNDK: $ANDROIDNDK"
        
    - name: Create minimal buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
[app]
title = Dental Test
package.name = dentaltest
package.domain = com.test

source.dir = .
source.include_exts = py,png,jpg,kv,ttf,json,db
version = 0.1

requirements = python3,kivy==2.3.0

android.permissions = INTERNET

android.api = 33
android.minapi = 21
android.sdk = 33
android.ndk = 25c
android.ndk_api = 21
android.arch = arm64-v8a

orientation = portrait
fullscreen = 0

[buildozer]
log_level = 2
warn_on_root = 0
EOF
        
        echo "=== buildozer.spec creado ==="
        cat buildozer.spec
        
    - name: Create minimal test app
      run: |
        cat > main.py << 'EOF'
from kivy.app import App
from kivy.uix.label import Label

class DentalApp(App):
    def build(self):
        return Label(text='¡App Dental Funcionando!')

if __name__ == '__main__':
    DentalApp().run()
EOF
        
        echo "=== main.py creado ==="
        cat main.py
        
    - name: Run Buildozer with FULL DEBUG
      run: |
        rm -rf .buildozer bin 2>/dev/null || true
        
        echo "=== INICIANDO BUILD CON LOG LEVEL 3 ==="
        
        buildozer -v 3 android debug 2>&1 | tee full_build.log || true
        
        echo "=== FIN DEL BUILD ==="
        
    - name: Analyze build logs
      run: |
        echo "=== ANÁLISIS DE LOGS ==="
        echo "1. Últimas 100 líneas del log:"
        tail -100 full_build.log || echo "No hay log"
        
        echo ""
        echo "2. Buscando errores:"
        grep -i -A5 -B5 "error\|fail\|exception\|traceback" full_build.log || echo "No se encontraron errores obvios"
        
        echo ""
        echo "3. Estado de directorios:"
        echo "¿Existe .buildozer/android/platform/build-* ?"
        ls -la .buildozer/android/platform/ 2>/dev/null || echo "No existe .buildozer/android/platform"
        
        echo ""
        echo "4. Buscando cualquier archivo .apk:"
        find . -type f -name "*.apk" 2>/dev/null || echo "NO HAY APK"
        
    - name: Upload FULL logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-debug-logs
        path: |
          full_build.log
        retention-days: 7
        
    - name: Check for APK
      if: always()
      run: |
        echo "=== BUSQUEDA EXHAUSTIVA DE APK ==="
        find . -name "*.apk" -type f 2>/dev/null || echo "NO SE ENCONTRÓ NINGÚN APK"
